name: Build & Release Keycloak

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/keycloak
  DRY_RUN: ${{ github.event_name == 'pull_request' }}

jobs:
  # --------------------------------------------------
  # CI / Lint
  # --------------------------------------------------
  lint-sigic-theme:
    name: Lint Keycloak sigic theme
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install lint tools
        run: |
          sudo apt-get update
          sudo apt-get install -y npm libfreemarker-java
          npm install -g stylelint stylelint-config-standard stylelint-config-prettier stylelint-config-standard-scss stylelint-scss

      - name: Setup ESLint flat config
        run: |
          mkdir eslint-env
          cd eslint-env
          npm init -y
          npm install eslint @eslint/js eslint-config-prettier eslint-plugin-prettier globals
          echo '{ "type": "module" }' > package.json
          cd ..
          cp keycloak/eslint.config.js eslint-env/eslint.config.js

      - name: Validate FTL templates
        run: |
          mkdir -p build/classes
          javac -d build/classes -cp /usr/share/java/freemarker.jar keycloak/tools/CheckFtl.java
          find keycloak/themes/sigic -name '*.ftl' > ftl_files.txt
          java -cp build/classes:/usr/share/java/freemarker.jar tools.CheckFtl $(cat ftl_files.txt)

      - name: Lint CSS
        run: stylelint "keycloak/themes/sigic/**/*.css" --config keycloak/stylelint.config.js

      - name: Lint JS
        run: node eslint-env/node_modules/eslint/bin/eslint.js "keycloak/themes/sigic/**/*.js" --config eslint-env/eslint.config.js

  # --------------------------------------------------
  # Build / Release
  # --------------------------------------------------
  build-release:
    runs-on: ubuntu-latest
    needs: lint-sigic-theme

    concurrency:
      group: release-main
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------------------------
      # Verificar que el commit es el HEAD real de main
      # (solo en release real)
      # -----------------------------------------------
      - name: Ensure commit is HEAD of origin/main
        if: env.DRY_RUN != 'true'
        run: |
          git fetch origin main
          MAIN_HEAD=$(git rev-parse origin/main)
          CURRENT="${{ github.sha }}"

          if [ "$CURRENT" != "$MAIN_HEAD" ]; then
            echo "❌ Este commit NO es el HEAD actual de main"
            echo "   current: $CURRENT"
            echo "   main:    $MAIN_HEAD"
            exit 1
          fi

          echo "✅ Commit corresponde al main real"

      # -----------------------------------------------
      # Verificar CI global usando Check Runs (SIN deadlock)
      # -----------------------------------------------
      - name: Verify completed check-runs
        if: env.DRY_RUN != 'true'
        run: |
          RAW=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/commits/${{ github.sha }}/check-runs")

          FAILED=$(echo "$RAW" | jq '
            [.check_runs[]
              | select(.status == "completed")
              | select(.conclusion != "success")
            ] | length')

          if [ "$FAILED" -ne 0 ]; then
            echo "❌ Hay checks completados con error"
            echo "$RAW" | jq '.check_runs[] | {name, status, conclusion}'
            exit 1
          fi

          echo "✅ Todos los checks completados están OK"

      # -----------------------------------------------
      # Resolver versión (Dockerfile + tags)
      # -----------------------------------------------
      - name: Resolve version
        id: version
        run: |
          BASE_VERSION=$(sed -n 's/^FROM .*:\([0-9]\+\.[0-9]\+\.[0-9]\+\)$/\1/p' keycloak/Dockerfile)

          if [ -z "$BASE_VERSION" ]; then
            echo "❌ No se pudo extraer versión base del Dockerfile"
            exit 1
          fi

          git fetch --tags

          LAST_TAG=$(git tag --list "$BASE_VERSION*" --sort=-v:refname | head -n1)

          if [ -z "$LAST_TAG" ]; then
            FINAL_VERSION="$BASE_VERSION"
          elif [ "$LAST_TAG" = "$BASE_VERSION" ]; then
            FINAL_VERSION="$BASE_VERSION.1"
          else
            PATCH="${LAST_TAG##*.}"
            FINAL_VERSION="$BASE_VERSION.$((PATCH + 1))"
          fi

          IMAGE="$(echo "$REGISTRY/$IMAGE_NAME" | tr '[:upper:]' '[:lower:]')"

          {
            echo "version=$FINAL_VERSION"
            echo "base=$BASE_VERSION"
            echo "image=$IMAGE"
          } >> $GITHUB_OUTPUT

          echo "➡️ Version calculada: $FINAL_VERSION"
          echo "➡️ Base flotante:     $BASE_VERSION"
          echo "➡️ Dry run:           $DRY_RUN"

      # -----------------------------------------------
      # Login GHCR (solo release real)
      # -----------------------------------------------
      - name: Login GHCR
        if: env.DRY_RUN != 'true'
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            docker login ghcr.io -u ${{ github.actor }} --password-stdin

      # -----------------------------------------------
      # Build image (siempre)
      # -----------------------------------------------
      - name: Build image
        run: |
          docker build \
            -t "${{ steps.version.outputs.image }}:${{ steps.version.outputs.version }}" \
            ./keycloak

      # -----------------------------------------------
      # Push imagen + tags flotantes (solo release real)
      # -----------------------------------------------
      - name: Push image and floating tags
        if: env.DRY_RUN != 'true'
        run: |
          IMAGE="${{ steps.version.outputs.image }}"
          VERSION="${{ steps.version.outputs.version }}"
          BASE="${{ steps.version.outputs.base }}"

          docker push "$IMAGE:$VERSION"

          docker tag "$IMAGE:$VERSION" "$IMAGE:$BASE"
          docker tag "$IMAGE:$VERSION" "$IMAGE:latest"

          docker push "$IMAGE:$BASE"
          docker push "$IMAGE:latest"

      # -----------------------------------------------
      # Crear Git tag (solo release real)
      # -----------------------------------------------
      - name: Create Git tag
        if: env.DRY_RUN != 'true'
        run: |
          git tag "${{ steps.version.outputs.version }}"
          git push origin "${{ steps.version.outputs.version }}"

      # -----------------------------------------------
      # GitHub Release (solo release real)
      # -----------------------------------------------
      - name: Create GitHub Release
        if: env.DRY_RUN != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Keycloak ${{ steps.version.outputs.version }}"
          generate_release_notes: true
