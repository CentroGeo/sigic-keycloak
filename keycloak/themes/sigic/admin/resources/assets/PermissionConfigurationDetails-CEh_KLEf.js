import{jsx as e,jsxs as S,Fragment as H}from"react/jsx-runtime";import{u as M,d as ce,a as z,l as U,V as Y,J as le,M as _,m as W,F as pe,n as Z,Y as G,$ as de,A as Q,h as k,B as V,E as me,G as ue,H as ye,q,z as X,j as R,w as ee,e4 as ge,f as ie,aI as se,aJ as te,D as K,aj as oe,b6 as ne,Z as Pe,K as fe,N as he,a5 as ve,O as Ce,b as Te,dT as J,y as Se,P as we,L as be,e5 as xe}from"./main-Dml5vH_M.js";import{useEffect as Ae,useState as x,useMemo as Fe}from"react";import{u as Ie}from"./ConfirmDialog-BN0phSta.js";import{F as Oe}from"./FormAccess-Dgk035ov.js";import{V as De}from"./ViewHeader-CnGpO8mW.js";import{u as Ee}from"./useParams-Cmi1OAEj.js";import{L as ke,a as Ne}from"./policyRepresentation-CscDyJFY.js";import{L as Ve,G as $,J as Ke,T as Le,a as Re,b as Me,C as ze,c as qe,d as Be,e as He,f as je}from"./NewPolicyDialog-Diogklhm.js";import{c as L}from"./capitalize-BoQP_j-K.js";import{s as j}from"./sortBy-D3c44bb2.js";import{F as re}from"./filter-icon-BO7Evf9d.js";import{S as Ge}from"./ScopePicker-Bg-Itgx4.js";import{u as Je,R as $e}from"./useSortedResourceTypes-D-nXlE6v.js";import"react-dom";import"./useIsAdminPermissionsClient-IDuSpu5V.js";import"./useLocaleSort-DeXbTEE9.js";import"./ClientSelect-DJq4F1jh.js";import"./ClientScopeTypes-DwzbyHD6.js";import"./utils-C-TUnOch.js";import"./GroupPickerDialog-eQJqBPQt.js";import"./DataListItemRow-B3J1tfyO.js";import"./CodeEditor-C7HQ48Ys.js";import"./SwitchControl-DVIXTwQM.js";import"./AddRoleMappingModal-FlNvMd3n.js";import"./translationFormatter-DtFomvax.js";import"./DatePicker-CU4S68sS.js";import"./debounce-DrUiQQ8A.js";import"./_baseSlice-F8doVSIJ.js";import"./_baseFlatten-BhRqdSvr.js";const Ue={name:"",description:"",type:"group",policies:[],decisionStrategy:Ne.UNANIMOUS,logic:ke.POSITIVE},B={aggregate:He,client:Be,user:qe,"client-scope":ze,group:$,regex:Me,role:Re,time:Le,js:Ke,default:$},Ye=r=>r in B,_e=({permissionClientId:r,providers:l,policies:b,toggleDialog:t,onAssign:n})=>{const{adminClient:o}=M(),{realmRepresentation:A}=ce(),{t:p}=z(),y=U({mode:"onChange",defaultValues:Ue}),{addAlert:F,addError:E}=Y(),{handleSubmit:T,reset:v}=y,I=A?.adminPermissionsEnabled,P=le({control:y.control,name:"type"});function a(){return P&&Ye(P)?B[P]:B.default}const m=a();Ae(()=>{if(P){const{name:c,description:C,decisionStrategy:O,logic:w}=y.getValues();v({type:P,name:c,description:C,decisionStrategy:O,logic:w})}},[P,v,y]);const u=async c=>{const{groups:C,roles:O,policies:w,clients:D,...s}=c,g={...s,...C&&C.length>0&&{groups:C},...O&&O.length>0&&{roles:O},...w&&w.length>0&&{policies:w},...D&&D.length>0&&{clients:D},...s.type==="group"&&(!C||C.length===0)&&{groups:[]},...s.type==="client"&&(!D||D.length===0)&&{clients:[]}};try{const d=await o.clients.createPolicy({id:r,type:P},g);n(d),t(),F(p("createPolicySuccess"),q.success)}catch(d){E("policySaveError",d)}};return e(_,{"aria-label":p("createPermissionPolicy"),variant:W.medium,header:e(me,{children:e(ue,{component:ye.h1,children:p("createPermissionPolicy")})}),isOpen:!0,onClose:t,children:S(pe,{id:"createPermissionPolicy-form",onSubmit:c=>{c.stopPropagation(),T(u)(c)},isHorizontal:!0,children:[S(Z,{...y,children:[e(G,{name:"name",label:p("name"),rules:{required:p("required")}}),e(G,{name:"description",label:p("description")}),l&&l.length>0&&e(de,{name:"type",label:p("policyType"),labelIcon:p("policyTypeHelpText"),options:l.map(c=>({key:c.type,value:L(c.type)})),controller:{defaultValue:""}}),e(m,{isPermissionClient:I,permissionClientId:r}),e(Ve,{})]}),e(Q,{children:S("div",{className:"pf-v5-u-mt-md",children:[e(k,{variant:V.primary,className:"pf-v5-u-mr-md",type:"submit","data-testid":"save",isDisabled:b?.length===0&&P==="aggregate",children:p("save")}),e(k,{variant:"link","data-testid":"cancel",onClick:t,children:p("cancel")})]})})]})})},We=({toggleDialog:r,onAssign:l,open:b,permissionClientId:t})=>{const{t:n}=z(),{adminClient:o}=M(),[A,p]=x([]),[y,F]=x(void 0),[E,T]=X(),[v,I]=x([]);R(()=>o.clients.listPolicyProviders({id:t}),a=>{const m=a.filter(u=>u.type!=="resource"&&u.type!=="scope").map(u=>u.name).filter(u=>u!==void 0);I(j(m))},[t]);const P=async(a,m,u)=>{const c={id:t,permission:"false",first:a,max:m};return u&&(c.name=u),y&&(c.type=y),await o.clients.listPolicies(c)||[]};return e(_,{variant:W.medium,title:n("assignExistingPolicies"),isOpen:b,onClose:r,actions:[S(H,{children:[e(k,{id:"modal-assignExistingPolicies","data-testid":"confirm",variant:V.primary,onClick:()=>{const a=A.map(m=>({policy:m}));l(a),r()},isDisabled:A.length===0,children:n("assign")},"assign"),e(k,{id:"modal-cancelExistingPolicies","data-testid":"cancel",variant:V.link,onClick:()=>{p([]),r()},children:n("cancel")},"cancel")]})],children:e(ee,{loader:P,ariaLabelKey:n("chooseAPolicyType"),searchPlaceholderKey:n("searchClientAuthorizationPolicy"),isSearching:!0,searchTypeComponent:e(se,{onSelect:(a,m)=>{F(m),T()},onOpenChange:T,toggle:a=>e(oe,{ref:a,"data-testid":"filter-type-dropdown-existingPolicies",id:"toggle-id-10",onClick:T,icon:e(re,{}),statusIcon:e(ne,{}),children:y||n("allTypes")}),isOpen:E,children:S(te,{children:[e(K,{"data-testid":"filter-type-dropdown-existingPolicies-all",onClick:()=>F(void 0),children:n("allTypes")},"all"),v.map(a=>e(K,{"data-testid":`filter-type-dropdown-existingPolicies-${a}`,onClick:()=>F(a),children:a},a))]})}),canSelectAll:!0,onSelect:a=>p(a),columns:[{name:"name"},{name:"type",cellFormatters:[ge()]},{name:"description"}],emptyState:e(ie,{message:n("emptyAssignExistingPolicies"),instructions:n("emptyAssignExistingPoliciesInstructions")})},y)})},Ze=({permissionClientId:r,providers:l,policies:b,resourceType:t})=>{const{adminClient:n}=M(),{t:o}=z(),{control:A,getValues:p,setValue:y,trigger:F,formState:{errors:E}}=Pe(),T=p("policies"),[v,I]=x(!1),[P,a]=x(!1),[m,u]=x([]),[c,C]=x(void 0),[O,w]=X();R(()=>T&&T.length>0?Promise.all(T.map(i=>n.clients.findOnePolicy({id:r,type:i.type,policyId:i.id}))):Promise.resolve([]),i=>{const f=i.filter(h=>h);u(f)},[b]);const D=j(l?l.filter(i=>i.type!=="resource"&&i.type!=="scope").map(i=>i.name):[]),s=i=>{const f=i.map(({policy:h})=>({id:h.id}));y("policies",[...p("policies")||[],...f]),F("policies"),u([...m,...i.map(({policy:h})=>h)])},g=i=>{const f=m.filter(h=>h.id!==i.id);u(f),y("policies",f.map(h=>({id:h.id,name:h.name,type:h.type,description:h.description})))},d=c?m.filter(i=>L(i.type)===c):m;return S(fe,{label:o("policies"),labelIcon:e(Ce,{helpText:o("permissionPoliciesHelp"),fieldLabelId:"policies"}),fieldId:"policies",isRequired:!0,children:[e(he,{name:"policies",control:A,defaultValue:[],rules:{validate:i=>!i||i.length===0?!1:i.every(({id:f})=>f&&f.trim().length>0)},render:()=>S(H,{children:[v&&e(We,{permissionClientId:r,open:v,toggleDialog:()=>I(!v),onAssign:s}),P&&e(_e,{toggleDialog:()=>a(!P),permissionClientId:r,providers:l,policies:b,resourceType:t,onAssign:i=>{s([{policy:i}])}}),e(k,{"data-testid":"select-assignedPolicy-button",variant:"secondary",onClick:()=>{I(!0)},children:o("assignExistingPolicies")}),e(k,{"data-testid":"select-createNewPolicy-button",className:"pf-v5-u-ml-md",variant:"secondary",onClick:()=>{a(!0)},children:o("createNewPolicy")})]})}),m.length>0&&e(ee,{loader:d,ariaLabelKey:o("policies"),searchPlaceholderKey:o("searchClientAuthorizationPolicy"),isSearching:!0,searchTypeComponent:e(se,{onSelect:(i,f)=>{C(f),w()},onOpenChange:w,toggle:i=>e(oe,{ref:i,"data-testid":"filter-type-dropdown-existingPolicies",id:"toggle-id-10",onClick:w,icon:e(re,{}),statusIcon:e(ne,{}),children:c?L(c):o("allTypes")}),isOpen:O,children:S(te,{children:[e(K,{"data-testid":"filter-type-dropdown-existingPolicies-all",onClick:()=>C(void 0),children:o("allTypes")},"all"),D.map(i=>e(K,{"data-testid":`filter-type-dropdown-existingPolicies-${i}`,onClick:()=>C(i),children:i},i))]})}),actionResolver:i=>[{title:o("unAssignPolicy"),onClick:()=>g(i.data)}],columns:[{name:"name",displayKey:o("name")},{name:"type",displayKey:o("type"),cellFormatters:[i=>L(String(i||""))]},{name:"description",displayKey:o("description")}],emptyState:e(ie,{message:o("emptyAssignExistingPolicies"),instructions:o("emptyAssignExistingPoliciesInstructions")})}),E.policies&&e(ve,{message:o("requiredPolicies")})]})};function Ii(){const{adminClient:r}=M(),{t:l}=z(),{realm:b,permissionClientId:t,permissionId:n,resourceType:o}=Ee(),A=Te(),p=U(),{handleSubmit:y,reset:F}=p,{addAlert:E,addError:T}=Y(),[v,I]=x(),[P,a]=x(),[m,u]=x(),c=Je({clientId:t}),C=Fe(()=>c.filter(({type:s})=>s===o).flatMap(({scopes:s=[]})=>s).map(s=>s||""),[c,o]);R(async()=>{if(!t)return{};const[s,g]=await Promise.all([r.clients.listPolicyProviders({id:t}),r.clients.listPolicies({id:t,permission:"false"})]);return{providers:s,policies:g}},({providers:s,policies:g})=>{const d=s?.filter(i=>i.type!=="resource"&&i.type!=="scope");a(j(d,i=>i.type)),u(g||[])},[t]),R(async()=>{if(!n)return{};const[s,g,d,i]=await Promise.all([r.clients.findOnePermission({id:t,type:"scope",permissionId:n}),r.clients.getAssociatedResources({id:t,permissionId:n}),r.clients.getAssociatedPolicies({id:t,permissionId:n}),r.clients.getAssociatedScopes({id:t,permissionId:n})]);if(!s)throw new Error(l("notFound"));return{permission:s,resources:g,policies:d,scopes:i}},({permission:s,resources:g,policies:d,scopes:i})=>{const f=g?.map(N=>N.name)||[],h=d?.map(N=>N.id)||[],ae=i?.map(N=>N.name)||[];F({...s,resources:f,policies:d,scopes:i}),I({...s,resources:f,policies:h,scopes:ae})},[t,n]);const O=async s=>{try{const g={...s,policies:s.policies?.map(d=>d.id),scopes:s.scopes?.map(d=>d.name),resourceType:o};if(n)await r.clients.updatePermission({id:t,type:"scope",permissionId:n},g);else{const d=await r.clients.createPermission({id:t,type:"scope"},g);I(d),A(xe({realm:b,permissionClientId:t,permissionId:d.id,resourceType:o}))}E(l(n?"updatePermissionSuccess":"createPermissionSuccess"),q.success)}catch(g){T("permissionSaveError",g)}},[w,D]=Ie({titleKey:"deletePermission",messageKey:l("deleteAdminPermissionConfirm",{permission:v?.name}),continueButtonVariant:V.danger,continueButtonLabel:"confirm",onConfirm:async()=>{try{await r.clients.delPermission({id:t,type:"scope",permissionId:n}),E(l("permissionDeletedSuccess"),q.success),A(J({realm:b,permissionClientId:t,tab:"permissions"}))}catch(s){T("permissionDeletedError",s)}}});return v?S(H,{children:[e(D,{}),e(De,{titleKey:n?v?.name:l("createPermission"),subKey:n?v?.description:l("createPermissionOfType",{resourceType:o}),dropdownItems:n?[e(K,{"data-testid":"delete-permission",onClick:()=>w(),children:l("delete")},"delete")]:void 0}),e(we,{variant:"light",children:S(Oe,{isHorizontal:!0,onSubmit:y(O),role:"anyone",children:[S(Z,{...p,children:[e(je,{clientId:t}),e(Ge,{clientId:t,resourceTypeScopes:C??[]}),e($e,{resourceType:o}),e(Ze,{permissionClientId:t,providers:P,policies:m,resourceType:o})]}),e(Q,{children:S("div",{className:"pf-v5-u-mt-md",children:[e(k,{variant:V.primary,className:"pf-v5-u-mr-md",type:"submit","data-testid":"save",children:l("save")}),e(k,{variant:"link","data-testid":"cancel",component:s=>e(be,{...s,to:J({realm:b,permissionClientId:t,tab:"permissions"})}),children:l("cancel")})]})})]})})]}):e(Se,{})}export{Ii as default};
//# sourceMappingURL=PermissionConfigurationDetails-CEh_KLEf.js.map
