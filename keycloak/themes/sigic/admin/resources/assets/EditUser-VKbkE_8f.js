import{jsx as e,jsxs as y,Fragment as $}from"react/jsx-runtime";import{d8 as bt,cM as yt,f2 as Ct,f3 as vt,dv as wt,f4 as It,f5 as kt,f6 as Tt,u as Q,a as K,M as We,m as Be,w as Ie,bD as Pt,h as M,c as Dt,b as it,V as ne,d as Te,z as Oe,j as Me,e4 as At,B as pe,dO as ot,e2 as Lt,f as Fe,T as Se,aI as dt,aJ as lt,D as ke,aj as ct,L as mt,cQ as St,Z as Et,P as fe,cx as je,q as J,aT as q,aU as Re,U as xt,W as Rt,aM as Ve,dz as Ut,bm as qe,au as ge,aG as V,aN as He,aL as O,aW as Ot,l as Pe,F as Ke,K as Ne,a1 as ut,eN as Mt,di as Nt,J as Bt,n as ze,f7 as Ft,bH as Xe,a5 as Ze,y as pt,a8 as Kt,O as zt,bj as et,aw as Ge,ak as Gt,aO as $e,ca as jt,C as Vt,f8 as qt,cz as Ht,Y as tt,e as _t,bN as rt,E as Ee,G as xe,c3 as Wt,ap as _e,cI as $t,a$ as Jt,b0 as Qt,bR as Yt,aH as Xt,bQ as Zt,e$ as er,f0 as at}from"./main-Dml5vH_M.js";import{useState as g,useMemo as ht,useRef as tr,Fragment as rr}from"react";import{u as ue,C as gt}from"./ConfirmDialog-BN0phSta.js";import{u as me,R as ar}from"./RoutableTabs-D0MTj5jQ.js";import{V as sr}from"./ViewHeader-CnGpO8mW.js";import{U as nr}from"./UserProfileContext-CAK45ckM.js";import{u as Je}from"./useParams-Cmi1OAEj.js";import{d as ir}from"./differenceBy-BpiYyOKy.js";import{S as or,C as dr}from"./SearchInputComponent-CtocLptu.js";import{A as lr}from"./AttributeForm-yvG_5yiW.js";import{a as Ue,R as cr,F as mr,f as ur,U as pr,t as hr}from"./UserForm-D8nvs5TZ.js";import{U as gr}from"./userProfileMetadata-CFgHgJ2w.js";import{u as Qe}from"./useFormatDate-Puc65BKQ.js";import{s as ft}from"./sortBy-D3c44bb2.js";import{C as fr,S as br,i as yr}from"./SessionsTable-DfgS4rWw.js";import{u as Cr}from"./useLocaleSort-DeXbTEE9.js";import{P as vr}from"./pencil-alt-icon-B3dGJCA1.js";import{T as wr}from"./TimeSelectorControl-DHH4w5Wh.js";import{D as Ir}from"./SwitchControl-DVIXTwQM.js";import{G as kr,a as Tr}from"./GroupPickerDialog-eQJqBPQt.js";import{Q as Pr}from"./question-circle-icon-CcYP0FMt.js";import{c as ye}from"./capitalize-BoQP_j-K.js";import{R as Dr}from"./AddRoleMappingModal-FlNvMd3n.js";import{U as Ar}from"./UserEvents-D0ZF_c1b.js";/* empty css                     */import{A as Lr}from"./AdminEvents-BQlKf8zR.js";import{a as ee,b as te,T as Sr}from"./Tabs-swfKYDgo.js";import"react-dom";import"./PageHandler-BQ1_55gR.js";import"./DynamicComponents-Cxsqsl9R.js";import"./ClientSelect-DJq4F1jh.js";import"./FileUpload-B3CkDAbJ.js";import"./KeySelect-Ba6sDuzD.js";import"./MultiLineInput-BnUu5qtj.js";import"./CodeEditor-C7HQ48Ys.js";import"./constants-BclHbWtx.js";import"./_baseFlatten-BhRqdSvr.js";import"./FormAccess-Dgk035ov.js";import"./KeyValueInput-CataZRq4.js";import"./CopyToClipboardButton-BjKMP6CQ.js";import"./TimeSelector-jOZGz2AQ.js";import"./DataListItemRow-B3J1tfyO.js";import"./_baseSlice-F8doVSIJ.js";import"./translationFormatter-DtFomvax.js";import"./filter-icon-BO7Evf9d.js";import"./DropdownPanel-CdQAMxBj.js";import"./warning-triangle-icon-DjlHdM0O.js";import"./pickBy-BQkB_pck.js";import"./DatePicker-CU4S68sS.js";import"./DescriptionListTerm-DCQWux3S.js";var Er="[object Map]",xr="[object Set]",Rr=Object.prototype,Ur=Rr.hasOwnProperty;function st(t){if(t==null)return!0;if(bt(t)&&(yt(t)||typeof t=="string"||typeof t.splice=="function"||Ct(t)||vt(t)||wt(t)))return!t.length;var a=It(t);if(a==Er||a==xr)return!t.size;if(kt(t))return!Tt(t).length;for(var s in t)if(Ur.call(t,s))return!1;return!0}const Or=({isJoin:t=!0,existingOrgs:a,onAdd:s,onClose:n})=>{const{adminClient:p}=Q(),{t:o}=K(),[c,f]=g([]),u=async(m,h,i)=>{const I={first:m,search:i,max:h+a.length},k=await p.organizations.find(I);return ir(k,a,"id")};return e(We,{variant:Be.small,title:o(t?"joinOrganization":"sendInvitation"),isOpen:!0,onClose:n,actions:[e(M,{"data-testid":"join",variant:"primary",onClick:async()=>{await s(c),n()},children:o(t?"join":"send")},"confirm"),e(M,{"data-testid":"cancel",variant:"link",onClick:n,children:o("cancel")},"cancel")],children:e(Ie,{loader:u,isPaginated:!0,ariaLabelKey:"organizationsList",searchPlaceholderKey:"searchOrganization",canSelectAll:!0,onSelect:m=>f([...m]),columns:[{name:"name",displayKey:"organizationName"},{name:"description",cellRenderer:m=>e(Pt,{wrapModifier:"truncate",children:m.description})}]})})},Mr=({user:t})=>{const{adminClient:a}=Q(),{t:s}=K(),{id:n}=Dt(),p=it(),{addAlert:o,addError:c}=ne(),{realm:f}=Te(),[u,m]=g(0),h=()=>m(u+1),[i,I,k]=Oe(),[T,x]=g(!0),[C,R]=g(!1),[Y,re]=g([]),[H,z]=g([]),[j,_]=g(""),[L,U]=g(""),[d,S]=g([]),[F,l]=g(!1),E=[{value:"Managed",label:"Managed"},{value:"Unmanaged",label:"Unmanaged"}],N=()=>{l(!F)},W=(D,B)=>{d.includes(B)?S(d.filter(G=>G!==B)):S([...d,B]),l(!1),h()};Me(async()=>{const D=await a.organizations.memberOrganizations({userId:n});let G=await Promise.all(D.map(async de=>{const ae=de.id,we=(await a.organizations.listMembers({orgId:ae})).filter(le=>le.username===t.username).map(le=>At()(le.membershipType));return{...de,membershipType:we}}));return d.length>0&&(G=G.filter(de=>de.membershipType?.some(ae=>d.includes(ae)))),L&&(G=G.filter(de=>de.name?.toLowerCase().includes(L.toLowerCase()))),G},re,[u,d,L]);const ie=D=>{_(D)},he=()=>{U(j),h()},oe=()=>{_(""),U(""),h()},[be,Ce]=ue({titleKey:"removeConfirmOrganizationTitle",messageKey:s("organizationRemoveConfirm",{count:H.length}),continueButtonLabel:"remove",continueButtonVariant:pe.danger,onConfirm:async()=>{try{await Promise.all(H.map(B=>a.organizations.delMember({orgId:B.id,userId:n}))),o(s("organizationRemovedSuccess")),await a.users.findOne({id:n})||p(ot({realm:f})),z([]),h()}catch(D){c("organizationRemoveError",D)}}});return y($,{children:[C&&e(Or,{isJoin:T,existingOrgs:Y,onClose:()=>R(!1),onAdd:async D=>{try{await Promise.all(D.map(B=>{const G=new FormData;return G.append("id",n),T?a.organizations.addMember({orgId:B.id,userId:n}):a.organizations.inviteExistingUser({orgId:B.id},G)})),o(s(T?"userAddedOrganization":"userInvitedOrganization",{count:D.length})),h()}catch(B){c(T?"userAddedOrganizationError":"userInvitedError",B)}}}),e(Ce,{}),e(Lt,{link:({organization:D,children:B})=>e(mt,{to:St({realm:f,id:D.id,tab:"settings"}),children:B},D.id),loader:Y,isSearching:L.length>0||d.length>0,onSelect:D=>z(D),deleteLabel:"remove",onDelete:D=>{z([D]),be()},toolbarItem:y($,{children:[e(Se,{children:e(or,{value:j,placeholder:s("searchMembers"),onChange:ie,onSearch:he,onClear:oe,"aria-label":s("searchMembers")})}),e(Se,{children:e(dt,{onOpenChange:k,toggle:D=>e(ct,{ref:D,id:"toggle-id",onClick:I,variant:"primary",children:s("joinOrganization")}),isOpen:i,children:y(lt,{children:[e(ke,{onClick:()=>{x(!0),R(!0)},children:s("joinOrganization")},"join"),e(ke,{onClick:()=>{x(!1),R(!0)},children:s("sendInvite")},"invite")]})})}),e(Se,{children:e(M,{"data-testid":"removeOrganization",variant:"secondary",isDisabled:H.length===0,onClick:()=>be(),children:s("remove")})}),e(Se,{children:e(dr,{filterPlaceholderText:s("filterByMembershipType"),isOpen:F,options:E,onOpenChange:D=>l(D),onToggleClick:N,onSelect:W,selectedItems:d,width:"260px"})})]}),children:e(Fe,{message:s("emptyUserOrganizations"),instructions:s("emptyUserOrganizationsInstructions"),secondaryActions:[{text:s("joinOrganization"),onClick:()=>{x(!0),R(!0)}},{text:s("sendInvitation"),onClick:()=>{x(!1),R(!0)}}]})})]})},Nr=({user:t,save:a,upConfig:s})=>{const n=Et();return e(fe,{variant:je.light,children:e(lr,{form:n,save:a,fineGrainedAccess:t.access?.manage,reset:()=>n.reset({...n.getValues(),attributes:Ue(t).attributes}),name:"unmanagedAttributes",isDisabled:gr.AdminView==s?.unmanagedAttributePolicy})})},Br=()=>{const{adminClient:t}=Q(),[a,s]=g(),{t:n}=K(),{addAlert:p,addError:o}=ne(),c=Qe(),[f,u]=g(0),{id:m}=Je(),h=C=>ft(C,R=>R.clientId?.toUpperCase()),i=()=>u(new Date().getTime()),I=async()=>{const C=await t.users.listConsents({id:m});return h(C)},k=({grantedClientScopes:C})=>e(xt,{className:"kc-consents-chip-group",children:C.map(R=>e(Rt,{isReadOnly:!0,className:"kc-consents-chip",children:R},R))}),[T,x]=ue({titleKey:"revokeClientScopesTitle",messageKey:n("revokeClientScopes",{clientId:a?.clientId}),continueButtonLabel:"revoke",continueButtonVariant:pe.danger,onConfirm:async()=>{try{await t.users.revokeConsent({id:m,clientId:a.clientId}),i(),p(n("deleteGrantsSuccess"),J.success)}catch(C){o("deleteGrantsError",C)}}});return y($,{children:[e(x,{}),e(Ie,{loader:I,ariaLabelKey:"roleList",searchPlaceholderKey:" ",columns:[{name:"clientId",displayKey:"Client",cellFormatters:[Re()],transforms:[q(20)]},{name:"grantedClientScopes",displayKey:"grantedClientScopes",cellRenderer:k,transforms:[q(30)]},{name:"createdDate",displayKey:"created",transforms:[q(20)],cellRenderer:({createdDate:C})=>C?c(new Date(C)):"—"},{name:"lastUpdatedDate",displayKey:"lastUpdated",transforms:[q(10)],cellRenderer:({lastUpdatedDate:C})=>C?c(new Date(C)):"—"}],actions:[{title:n("revoke"),onRowClick:C=>{s(C),T()}}],emptyState:e(Fe,{hasIcon:!0,icon:fr,message:n("noConsents"),instructions:n("noConsentsText")})},f)]})},Fr=({credentialData:t,onClose:a})=>{const{t:s}=K();return e(We,{variant:Be.medium,title:s("passwordDataTitle"),"data-testid":"passwordDataDialog",isOpen:!0,onClose:a,children:y(Ve,{"aria-label":s("passwordDataTitle"),"data-testid":"password-data-dialog",variant:Ut.compact,children:[e(qe,{children:y(ge,{children:[e(V,{children:s("showPasswordDataName")}),e(V,{children:s("showPasswordDataValue")})]})}),e(He,{children:t.map((n,p)=>y(ge,{children:[e(O,{children:n[0]}),e(O,{children:n[1]})]},p))})]})})},Kr=({credential:t,resetPassword:a,toggleDelete:s,children:n})=>{const p=Qe(),{t:o}=K(),[c,f]=Oe(),[u,m]=Oe(),h=Cr(),i=ht(()=>{if(!t.credentialData)return[];const I=JSON.parse(t.credentialData);return h(Object.entries(I),([k])=>k).map(([k,T])=>typeof T=="string"?[k,T]:[k,JSON.stringify(T)])},[t.credentialData]);return y($,{children:[c&&Object.keys(t).length!==0&&e(Fr,{credentialData:i,onClose:()=>{f()}}),e(O,{children:n}),e(O,{children:p(new Date(t.createdDate))}),e(O,{children:e(M,{className:"kc-showData-btn",variant:"link","data-testid":"showDataBtn",onClick:f,children:o("showDataBtn")})}),t.type==="password"?e(O,{isActionCell:!0,children:e(M,{variant:"secondary","data-testid":"resetPasswordBtn",onClick:a,children:o("resetPasswordBtn")})}):e(O,{}),e(O,{isActionCell:!0,children:e(dt,{popperProps:{position:"right"},onOpenChange:m,toggle:I=>e(ct,{ref:I,isExpanded:u,onClick:m,variant:"plain","aria-label":"Kebab toggle",children:e(Ot,{})}),isOpen:u,children:e(lt,{children:e(ke,{"data-testid":"deleteDropdownItem",component:"button",onClick:()=>{s(),m()},children:o("deleteBtn")},t.id)})})})]})},zr=({userId:t,credential:a,isEditable:s,toggle:n})=>{const{adminClient:p}=Q(),{t:o}=K(),{register:c,handleSubmit:f}=Pe(),{addAlert:u,addError:m}=ne();return e(Ke,{isHorizontal:!0,className:"kc-form-userLabel",onSubmit:f(async i=>{try{await p.users.updateCredentialLabel({id:t,credentialId:a.id},i.userLabel||""),u(o("updateCredentialUserLabelSuccess"),J.success),n()}catch(I){m("updateCredentialUserLabelError",I)}}),children:e(Ne,{fieldId:"kc-userLabel",className:"kc-userLabel-row",children:e("div",{className:"kc-form-group-userLabel",children:s?y($,{children:[e(ut,{"data-testid":"userLabelFld",defaultValue:a.userLabel,className:"kc-userLabel","aria-label":o("userLabel"),...c("userLabel")}),y("div",{className:"kc-userLabel-actionBtns",children:[e(M,{"data-testid":"editUserLabelAcceptBtn",variant:"link",className:"kc-editUserLabelAcceptBtn","aria-label":o("acceptBtn"),type:"submit",icon:e(Mt,{})}),e(M,{"data-testid":"editUserLabelCancelBtn",variant:"link",className:"kc-editUserLabel-cancelBtn","aria-label":o("cancelBtn"),onClick:n,icon:e(Nt,{})})]})]}):y($,{children:[a.userLabel,e(M,{"aria-label":o("editUserLabel"),variant:"link",className:"kc-editUserLabel-btn",onClick:n,"data-testid":"editUserLabelBtn",icon:e(vr,{})})]})})})})},Gr=()=>{const{t}=K();return e(wr,{name:"lifespan",label:t("lifespan"),labelIcon:t("lifespanHelp"),units:["minute","hour","day"],menuAppendTo:"parent",controller:{}})},jr=({userId:t,onClose:a})=>{const{adminClient:s}=Q(),{realmRepresentation:n}=Te(),{t:p}=K(),o=Pe({defaultValues:{actions:[],lifespan:n?.actionTokenGeneratedByAdminLifespan}}),{handleSubmit:c,control:f}=o,u=Bt({control:f,name:"actions"}),m=!st(u),{addAlert:h,addError:i}=ne(),I=async({actions:k,lifespan:T})=>{if(!st(k))try{await s.users.executeActionsEmail({id:t,actions:k,lifespan:T}),h(p("credentialResetEmailSuccess"),J.success),a()}catch(x){i("credentialResetEmailError",x)}};return e(gt,{variant:Be.medium,titleKey:"credentialReset",open:!0,onCancel:a,toggleDialog:a,continueButtonLabel:"credentialResetConfirm",onConfirm:()=>{c(I)()},confirmButtonDisabled:!m,children:e(Ke,{id:"userCredentialsReset-form",isHorizontal:!0,"data-testid":"credential-reset-modal",children:y(ze,{...o,children:[e(cr,{name:"actions",label:"resetAction",help:"resetActions"}),e(Gr,{})]})})})},Vr={password:"",passwordConfirmation:"",temporaryPassword:!0},qr=({user:t,isResetPassword:a,onAddRequiredActions:s,refresh:n,onClose:p})=>{const{adminClient:o}=Q(),{t:c}=K(),f=Pe({defaultValues:Vr,mode:"onChange"}),{register:u,formState:{isValid:m,errors:h},watch:i,handleSubmit:I,clearErrors:k,setError:T}=f,[x,C]=Oe(!0),R=i("password",""),Y=i("passwordConfirmation",""),{addAlert:re,addError:H}=ne(),[z,j]=ue({titleKey:a?"resetPasswordConfirm":"setPasswordConfirm",messageKey:a?c("resetPasswordConfirmText",{username:t.username}):c("setPasswordConfirmText",{username:t.username}),continueButtonLabel:a?"resetPassword":"savePassword",continueButtonVariant:pe.danger,onConfirm:()=>I(_)()}),_=async({password:d,temporaryPassword:S})=>{try{await o.users.resetPassword({id:t.id,credential:{temporary:S,type:"password",value:d}}),S&&s?.([Ft.UPDATE_PASSWORD]);const l=(await o.users.getCredentials({id:t.id})).find(N=>N.type==="password");l&&l.federationLink===void 0&&await o.users.updateCredentialLabel({id:t.id,credentialId:l.id},c("defaultPasswordLabel")),re(c(a?"resetCredentialsSuccess":"savePasswordSuccess"),J.success),n()}catch(F){H(a?"resetPasswordError":"savePasswordError",F)}p()},{onChange:L,...U}=u("password",{required:!0});return y($,{children:[e(j,{}),e(gt,{titleKey:a?c("resetPasswordFor",{username:t.username}):c("setPasswordFor",{username:t.username}),open:x,onCancel:p,toggleDialog:C,onConfirm:z,confirmButtonDisabled:!m,continueButtonLabel:"save",children:y(Ke,{id:"userCredentials-form",isHorizontal:!0,className:"keycloak__user-credentials__reset-form",children:[y(Ne,{name:"password",label:c("password"),fieldId:"password",isRequired:!0,children:[e(Xe,{"data-testid":"passwordField",id:"password",onChange:d=>{L(d),Y!==d.currentTarget.value?T("passwordConfirmation",{message:c("confirmPasswordDoesNotMatch").toString()}):k("passwordConfirmation")},...U}),h.password&&e(Ze,{message:c("required")})]}),y(Ne,{name:"passwordConfirmation",label:c(a?"resetPasswordConfirmation":"passwordConfirmation"),fieldId:"passwordConfirmation",isRequired:!0,children:[e(Xe,{"data-testid":"passwordConfirmationField",id:"passwordConfirmation",...u("passwordConfirmation",{required:!0,validate:d=>d===R||c("confirmPasswordDoesNotMatch").toString()})}),h.passwordConfirmation&&e(Ze,{message:h.passwordConfirmation.message})]}),e(ze,{...f,children:e(Ir,{name:"temporaryPassword",label:c("temporaryPassword"),labelIcon:c("temporaryPasswordHelpText"),className:"pf-v5-u-mb-md",defaultValue:"true"})})]})})]})},nt=({credential:t,userId:a,toggleDelete:s,resetPassword:n,isUserLabelEdit:p,setIsUserLabelEdit:o,refresh:c})=>e(Kr,{credential:t,toggleDelete:()=>s(t),resetPassword:n,children:e(zr,{credential:t,userId:a,isEditable:p?.status&&p.rowKey===t.id||!1,toggle:()=>{o({status:!p?.status,rowKey:t.id}),p?.status&&c()}})},t.id),Hr=({user:t,setUser:a})=>{const{adminClient:s}=Q(),{t:n}=K(),{addAlert:p,addError:o}=ne(),[c,f]=g(0),u=Qe(),m=()=>f(c+1),[h,i]=g(!1),[I,k]=g(!1),[T,x]=g([]),[C,R]=g([]),[Y,re]=g({}),[H,z]=g(!1),[j,_]=g(),L=tr(null),[U,d]=g({draggedItemId:"",draggingToItemIndex:-1,dragging:!1,tempItemOrder:[""]});Me(()=>s.users.getCredentials({id:t.id}),r=>{r=[...r.filter(w=>w.federationLink===void 0)],x(r);const b=r.reduce((w,A)=>(w[A.type]=w[A.type]||[],w[A.type].push(A),w),Object.create(null)),v=Object.keys(b).map(w=>({key:w,value:b[w]}));R(v.map(w=>({...w,isExpanded:!1})))},[c]);const S=()=>i(!h),F=()=>{k(!I)},l=()=>{z(!0),S()},[E,N]=ue({titleKey:n("deleteCredentialsConfirmTitle"),messageKey:n("deleteCredentialsConfirm"),continueButtonLabel:n("delete"),continueButtonVariant:pe.danger,onConfirm:async()=>{try{await s.users.deleteCredential({id:t.id,credentialId:Y.id}),p(n("deleteCredentialsSuccess"),J.success),f(r=>r+1)}catch(r){o("deleteCredentialsError",r)}}}),W=ht(()=>C.flatMap(r=>[r.value.map(({id:b})=>b).toString(),...r.isExpanded?r.value.map(b=>b.id):[]]),[C]),ie=r=>{r.dataTransfer.effectAllowed="move",r.dataTransfer.setData("text/plain",r.currentTarget.id);const b=r.currentTarget.id;r.currentTarget.classList.add(Ge.modifiers.ghostRow),r.currentTarget.setAttribute("aria-pressed","true"),d({...U,draggedItemId:b,dragging:!0})},he=(r,b,v)=>{const w=r.indexOf(b);if(w===v)return r;const A=[...r];return A.splice(v,0,A.splice(w,1)[0]),A},oe=r=>{if(!L.current)return;const b=L.current,v=Array.from(b.children);v.every(({id:w},A)=>w===r[A])||(b.replaceChildren(),r.forEach(w=>{b.appendChild(v.find(({id:A})=>A===w))}))},be=()=>{L.current&&(Array.from(L.current.children).forEach(r=>{r.classList.remove(Ge.modifiers.ghostRow),r.setAttribute("aria-pressed","false")}),d({...U,draggedItemId:"",draggingToItemIndex:-1,dragging:!1}))},Ce=r=>{D(r)||(oe(W),d({...U,draggingToItemIndex:-1}))},D=r=>{if(!L.current)return!1;const b=L.current.getBoundingClientRect();return r.clientX>b.x&&r.clientX<b.x+b.width&&r.clientY>b.y&&r.clientY<b.y+b.height},B=r=>{D(r)?De(U.draggedItemId,U.tempItemOrder):be()},G=r=>{r.preventDefault();const v=r.target.closest("tr");if(!(!v||L.current&&!L.current.contains(v)||v.id===U.draggedItemId)){const w=v.id,A=Array.from(L.current?.children||[]).findIndex(Z=>Z.id===w);if(A===U.draggingToItemIndex)return;const X=he(W,U.draggedItemId,A);oe(X),d({...U,draggingToItemIndex:A,tempItemOrder:X})}},de=r=>{a({...t,requiredActions:[...t.requiredActions??[],...r]})},ae=({target:r})=>{r instanceof HTMLTableRowElement&&(r.classList.remove(Ge.modifiers.ghostRow),r.setAttribute("aria-pressed","false"),d({...U,draggedItemId:"",draggingToItemIndex:-1,dragging:!1}))},De=async(r,b)=>{const v=W.findIndex(Z=>Z===r),w=b.findIndex(Z=>Z===r),A=w-v,X=r.split(",");try{for(const Z of X)for(let Ye=0;Ye<Math.abs(A);Ye++)A>0?await s.users.moveCredentialPositionDown({id:t.id,credentialId:Z,newPreviousCredentialId:W[w]}):await s.users.moveCredentialPositionUp({id:t.id,credentialId:Z});m(),p(n("updatedCredentialMoveSuccess"),J.success)}catch(Z){o("updatedCredentialMoveError",Z)}},ve=r=>{re(r),E()},we=t.federationLink,[le,Ae]=g([]);if(Me(()=>s.users.getCredentials({id:t.id}),r=>{r=[...r.filter(b=>b.federationLink!==void 0)],Ae(r)},[c]),!le)return e(pt,{});const Le=le.length>0,P=C.length===0,se=!t.credentials||t.credentials.length===0,ce=P&&se&&!Le;return y($,{children:[h&&e(qr,{user:t,isResetPassword:H,onAddRequiredActions:de,refresh:m,onClose:()=>i(!1)}),I&&e(jr,{userId:t.id,onClose:()=>k(!1)}),e(N,{}),t.email&&!ce&&e(M,{className:"kc-resetCredentialBtn-header",variant:"primary","data-testid":"credentialResetBtn",onClick:()=>k(!0),children:n("credentialResetBtn")}),T.length!==0&&!T.find(r=>r.type==="password")&&!le.find(r=>r.type==="password")&&y($,{children:[e(M,{className:"kc-setPasswordBtn-tbl","data-testid":"setPasswordBtn-table",variant:"primary",form:"userCredentials-form",onClick:()=>{i(!0)},children:n("setPassword")}),e(Kt,{})]}),C.length!==0&&e(fe,{variant:je.light,children:y(Ve,{variant:"compact",children:[e(qe,{children:y(ge,{className:"kc-table-header",children:[e(V,{children:e(zt,{helpText:n("userCredentialsHelpText"),fieldLabelId:"userCredentialsHelpTextLabel"})}),e(V,{"aria-hidden":"true"}),e(V,{children:n("type")}),e(V,{children:n("userLabel")}),e(V,{children:n("createdAt")}),e(V,{children:n("data")}),e(V,{"aria-hidden":"true"}),e(V,{"aria-hidden":"true"})]})}),e(He,{ref:L,onDragOver:G,onDrop:G,onDragLeave:Ce,children:C.map((r,b)=>y(rr,{children:[y(ge,{id:r.value.map(({id:v})=>v).toString(),draggable:C.length>1,onDrop:B,onDragEnd:ae,onDragStart:ie,children:[e(O,{className:C.length===1?"one-row":"",draggableRow:{id:`draggable-row-${r.value.map(({id:v})=>v)}`}}),r.value.length>1?e(O,{className:"kc-expandRow-btn",expand:{rowIndex:b,isExpanded:r.isExpanded,onToggle:(v,w)=>{const A=C.map((X,Z)=>Z===w?{...X,isExpanded:!X.isExpanded}:X);R(A)}}}):e(O,{}),e(O,{dataLabel:`columns-${r.key}`,className:"kc-notExpandableRow-credentialType","data-testid":"credentialType",children:et(r.key)}),r.value.length<=1&&r.value.map(v=>e(nt,{credential:v,userId:t.id,toggleDelete:ve,resetPassword:l,isUserLabelEdit:j,setIsUserLabelEdit:_,refresh:m},v.id))]}),r.isExpanded&&r.value.map(v=>y(ge,{id:v.id,draggable:!0,onDrop:B,onDragEnd:ae,onDragStart:ie,children:[e(O,{}),e(O,{className:"kc-draggable-dropdown-type-icon",draggableRow:{id:`draggable-row-${r.value.map(({id:w})=>w)}`}}),e(O,{dataLabel:`child-columns-${v.id}`,className:"kc-expandableRow-credentialType",children:et(v.type)}),e(nt,{credential:v,userId:t.id,toggleDelete:ve,resetPassword:l,isUserLabelEdit:j,setIsUserLabelEdit:_,refresh:m})]},v.id))]},r.key))})]})}),we&&Le&&e(fe,{variant:je.light,children:y(Ve,{variant:"compact",children:[e(qe,{children:y(ge,{children:[e(V,{children:n("type")}),e(V,{children:n("providedBy")}),e(V,{children:n("createdAt")}),e(V,{"aria-hidden":"true"})]})}),e(He,{children:le.map(r=>y(ge,{children:[e(O,{children:e("b",{children:r.type})}),e(O,{children:e(mr,{user:t})}),e(O,{children:u(new Date(r.createdDate))}),r.type==="password"&&e(O,{modifier:"fitContent",children:e(M,{variant:"secondary",onClick:S,children:n("setPassword")})})]},r.type))})]})}),ce&&e(Fe,{hasIcon:!0,message:n("noCredentials"),instructions:n("noCredentialsText"),primaryActionText:n("setPassword"),onPrimaryAction:S,secondaryActions:t.email?[{text:n("credentialResetBtn"),onClick:F,type:pe.link}]:void 0})]})},_r=({user:t})=>{const{adminClient:a}=Q(),{t:s}=K(),{addAlert:n,addError:p}=ne(),[o,c]=g(0),f=()=>c(o+1),[u,m]=g([]),[h,i]=g(!0),[I,k]=g([]),[T,x]=g(!1),{enabled:C}=Gt(),{hasAccess:R}=$e(),Y=R("manage-users"),re=d=>ft(d,S=>S.path?.toUpperCase()),H=async(d,S,F)=>{const l={first:d,max:S},E=F||"";E&&(l.search=E);const N=await a.users.listGroups({...l,id:t.id});k([...N]);const W=[];return h||N.forEach(ie=>{const he=(ie.path?.substring(1).match(/((~\/)|[^/])+/g)||[]).slice(0,-1);W.push(...he.map(oe=>({name:oe,path:ie.path?.substring(0,ie.path.indexOf(oe)+oe.length)})))}),re(Ht([...N,...W],"path"))},z=()=>{x(!T)},[j,_]=ue({titleKey:s("leaveGroup",{count:u.length,name:u[0]?.name}),messageKey:s("leaveGroupConfirmDialog",{count:u.length,groupname:u[0]?.name,username:t.username}),continueButtonLabel:"leave",continueButtonVariant:pe.danger,onConfirm:async()=>{try{await Promise.all(u.map(d=>a.users.delFromGroup({id:t.id,groupId:d.id}))),m([]),n(s("removedGroupMembership"),J.success)}catch(d){p("removedGroupMembershipError",d)}f()}}),L=d=>{m(d),j()},U=async d=>{try{await Promise.all(d.map(S=>a.users.addToGroup({id:t.id,groupId:S.id}))),n(s("addedGroupMembership"),J.success)}catch(S){p("addedGroupMembershipError",S)}f()};return y($,{children:[e(_,{}),T&&e(kr,{id:t.id,type:"selectMany",text:{title:s("joinGroupsFor",{username:t.username}),ok:"join"},canBrowse:Y,onClose:()=>x(!1),onConfirm:async(d=[])=>{await U(d),x(!1)}}),e(Ie,{loader:H,className:"keycloak_user-section_groups-table",isPaginated:!0,ariaLabelKey:"roleList",searchPlaceholderKey:"searchGroup",canSelectAll:!0,onSelect:d=>m(h?d:qt(d,I,"id")),isRowDisabled:d=>!h&&I.every(S=>S.id!==d.id),toolbarItem:y($,{children:[e(M,{className:"kc-join-group-button",onClick:z,"data-testid":"add-group-button",isDisabled:!t.access?.manageGroupMembership,children:s("joinGroup")}),e(jt,{label:s("directMembership"),id:"kc-direct-membership-checkbox",onChange:()=>{i(!h),f()},isChecked:h,className:"pf-v5-u-mt-sm"},"direct-membership-check"),e(M,{onClick:()=>L(u),"data-testid":"leave-group-button",variant:"link",isDisabled:u.length===0,className:"pf-v5-u-ml-md",children:s("leave")}),C&&e(Vt,{"aria-label":"Basic popover",position:"bottom",bodyContent:e("div",{children:s("whoWillAppearPopoverTextUsers")}),children:e(M,{variant:"link",className:"kc-who-will-appear-button",icon:e(Pr,{}),children:s("whoWillAppearLinkTextUsers")},"who-will-appear-button")})]}),columns:[{name:"groupMembership",displayKey:"groupMembership",cellRenderer:d=>d.name||"-",transforms:[q(40)]},{name:"path",displayKey:"path",cellRenderer:d=>e(Tr,{group:d}),transforms:[q(45)]},{name:"",cellRenderer:d=>I.some(F=>F.id===d.id)||I.length===0||h?e(M,{"data-testid":`leave-${d.name}`,onClick:()=>L([d]),variant:"link",isDisabled:!t.access?.manageGroupMembership,children:s("leave")}):"-",transforms:[q(20)]}],emptyState:e(Fe,{hasIcon:!0,message:s("noGroups"),instructions:s("noGroupsText"),primaryActionText:s("joinGroup"),onPrimaryAction:z})},o)]})},Wr=({userId:t,federatedId:a,onClose:s,onRefresh:n})=>{const{adminClient:p}=Q(),{t:o}=K(),{addAlert:c,addError:f}=ne(),u=Pe({mode:"onChange"}),{handleSubmit:m,formState:{isValid:h}}=u,i=async I=>{try{await p.users.addToFederatedIdentity({id:t,federatedIdentityId:a,federatedIdentity:I}),c(o("idpLinkSuccess"),J.success),s(),n()}catch(k){f("couldNotLinkIdP",k)}};return e(We,{variant:Be.small,title:o("linkAccountTitle",{provider:ye(a)}),onClose:s,actions:[e(M,{"data-testid":"confirm",variant:"primary",type:"submit",form:"group-form",isDisabled:!h,children:o("link")},"confirm"),e(M,{"data-testid":"cancel",variant:pe.link,onClick:s,children:o("cancel")},"cancel")],isOpen:!0,children:e(Ke,{id:"group-form",onSubmit:m(i),children:y(ze,{...u,children:[e(Ne,{label:o("identityProvider"),fieldId:"identityProvider",children:e(ut,{id:"identityProvider","data-testid":"idpNameInput",value:ye(a),readOnly:!0})}),e(tt,{name:"userId",label:o("userID"),helperText:o("userIdHelperText"),autoFocus:!0,rules:{required:o("required")}}),e(tt,{name:"userName",label:o("username"),helperText:o("usernameHelperText"),rules:{required:o("required")}})]})})})},$r=({userId:t})=>{const{adminClient:a}=Q(),[s,n]=g(0),[p,o]=g(""),[c,f]=g(!1),{realm:u}=Te(),{addAlert:m,addError:h}=ne(),{t:i}=K(),{hasAccess:I,hasSomeAccess:k}=$e(),T=k("manage-identity-providers","view-identity-providers"),x=()=>n(new Date().getTime()),C=_t().identityProviders,R=async()=>{const l=await a.users.listFederatedIdentities({id:t});if(T){const E=await a.identityProviders.find();for(const N of l)N.providerId=E.find(W=>W.alias===N.identityProvider)?.providerId}return l},Y=async()=>a.identityProviders.find(),re=async()=>R(),H=async()=>{const l=(await R()).map(E=>E.identityProvider);return(await Y())?.filter(E=>!l.includes(E.alias))},[z,j]=ue({titleKey:i("unlinkAccountTitle",{provider:ye(p)}),messageKey:i("unlinkAccountConfirm",{provider:ye(p)}),continueButtonLabel:"unlink",continueButtonVariant:pe.primary,onConfirm:async()=>{try{await a.users.delFromFederatedIdentity({id:t,federatedIdentityId:p}),m(i("idpUnlinkSuccess"),J.success),x()}catch(l){h("mappingDeletedError",l)}}}),_=l=>T?e(mt,{to:$t({realm:u,providerId:l.providerId,alias:l.identityProvider,tab:"settings"}),children:ye(l.identityProvider)}):e("span",{children:ye(l.identityProvider)}),L=l=>{const E=C?.find(N=>N.id===l.identityProvider)?.groupName;return e(_e,{color:E==="Social"?"blue":"orange",children:i(E==="Social"?"idpType.social":"idpType.custom")})},U=l=>{const E=C?.find(N=>N.id===l.providerId)?.groupName;return e(_e,{color:E==="User-defined"?"orange":"blue",children:E==="User-defined"?"Custom":E==="Social"?i("idpType.social"):E})},d=l=>I("manage-users")?e(M,{variant:"link",onClick:()=>{o(l.identityProvider),z()},children:i("unlinkAccount")}):e("span",{}),S=l=>e(M,{variant:"link",onClick:()=>{o(l.alias),f(!0)},children:i("linkAccount")}),F=()=>{const l=[{name:"identityProvider",displayKey:"name",cellRenderer:_,transforms:[q(20)]},{name:"userId",displayKey:"userID",cellFormatters:[Re()],transforms:[q(30)]},{name:"userName",displayKey:"username",cellFormatters:[Re()],transforms:[q(20)]},{name:"",cellRenderer:d,transforms:[q(20)]}];return T&&l.splice(1,0,{name:"type",displayKey:"type",cellRenderer:L,transforms:[q(10)]}),l};return y($,{children:[c&&e(Wr,{userId:t,federatedId:p,onClose:()=>f(!1),onRefresh:x}),e(j,{}),y(fe,{variant:"light",className:"pf-v5-u-p-0",children:[y(rt,{title:i("linkedIdPs"),className:"kc-linked-idps",children:[e(Ee,{children:e(xe,{className:"kc-available-idps-text",children:i("linkedIdPsText")})}),e(Ie,{loader:re,isPaginated:!1,ariaLabelKey:"LinkedIdPs",className:"kc-linked-IdPs-table",columns:F(),emptyState:e(Ee,{className:"kc-no-providers-text",children:e(xe,{children:i("noProvidersLinked")})})},s)]}),I("manage-users")&&T&&y(rt,{className:"kc-available-idps",title:i("availableIdPs"),children:[e(Ee,{children:e(xe,{className:"kc-available-idps-text",children:i("availableIdPsText")})}),e(Ie,{loader:H,isPaginated:!1,ariaLabelKey:"LinkedIdPs",className:"kc-linked-IdPs-table",columns:[{name:"alias",displayKey:"name",cellFormatters:[Re(),Wt()],transforms:[q(20)]},{name:"type",displayKey:"type",cellRenderer:U,transforms:[q(60)]},{name:"",cellRenderer:S}],emptyState:e(Ee,{className:"kc-no-providers-text",children:e(xe,{children:i("noAvailableIdentityProviders")})})},s)]})]})]})},Jr=({id:t,name:a})=>{const{adminClient:s}=Q(),{t:n}=K(),{addAlert:p,addError:o}=ne();return e(Dr,{name:a,id:t,type:"users",save:async f=>{try{const u=f.filter(m=>m.client===void 0).map(m=>m.role).flat();await s.users.addRealmRoleMappings({id:t,roles:u}),await Promise.all(f.filter(m=>m.client!==void 0).map(m=>s.users.addClientRoleMappings({id:t,clientUniqueId:m.client.id,roles:[m.role]}))),p(n("userRoleMappingUpdatedSuccess"),J.success)}catch(u){o("roleMappingUpdatedError",u)}}})},Qr=()=>{const{adminClient:t}=Q(),{id:a}=Je(),{realm:s}=Te(),{t:n}=K();return e(fe,{variant:"light",className:"pf-v5-u-p-0",children:e(br,{loader:()=>t.users.listSessions({id:a,realm:s}),hiddenColumns:["username","type"],emptyInstructions:n("noSessionsForUser"),logoutUser:a})})};function $a(){const{adminClient:t}=Q(),{t:a}=K(),{addAlert:s,addError:n}=ne(),p=it(),{hasAccess:o}=$e(),{id:c}=Je(),{realm:f,realmRepresentation:u}=Te(),h=Pe({mode:"onChange",resolver:async P=>({values:P,errors:{}})}),[i,I]=g(),[k,T]=g(),[x,C]=g(),[R,Y]=g(),[re,H]=g(0),z=()=>H(P=>P+1),j=yr(i?.id),[_,L]=g(),[U,d]=g(!1),F=Jt()(Qt.Organizations)&&u?.organizationsEnabled,l=P=>Yt({realm:f,id:i?.id||"",tab:P}),[E,N]=g("userEvents"),W=me(l("settings")),ie=me(l("attributes")),he=me(l("credentials")),oe=me(l("role-mapping")),be=me(l("groups")),Ce=me(l("organizations")),D=me(l("consents")),B=me(l("identity-provider-links")),G=me(l("sessions")),de=me(l("events"));Me(async()=>Promise.all([t.users.findOne({id:c,userProfileMetadata:!0}),t.attackDetection.findOne({id:c}),t.users.getUnmanagedAttributes({id:c}),t.users.getProfile({realm:f}),F?t.organizations.find({first:0,max:1}):[]]),([P,se,ce,r,b])=>{if(!P||!u||!se)throw new Error(a("notFound"));const{userProfileMetadata:v,...w}=P;Y(v),w.unmanagedAttributes=ce,w.attributes=ur(w.attributes,ce),r.unmanagedAttributePolicy!==void 0&&C(!0),I(w),L(r);const A=u.bruteForceProtected,X=A&&se.disabled;T({isBruteForceProtected:A,isLocked:X}),d(b.length===1),h.reset(Ue(w))},[re]);const ae=async P=>{try{await t.users.update({id:i.id},hr(P)),s(a("userSaved"),J.success),z()}catch(se){if(er(se)){if(x&&Array.isArray(P.unmanagedAttributes)){const ce=new Array(P.unmanagedAttributes.length);let r=!1;at(se,(b,v)=>{if(b.startsWith("attributes.")){const w=b.substring(11);P.unmanagedAttributes.forEach((A,X)=>{A.key===w&&(ce[X]=v,r=!0)})}else h.setError(b,v)},(b,v)=>a(b,v)),r&&h.setError("unmanagedAttributes",ce)}else at(se,h.setError,(ce,r)=>a(ce,r));n("userNotSaved","")}else n("userCreateError",se)}},[De,ve]=ue({titleKey:"disableConfirmUserTitle",messageKey:"disableConfirmUser",continueButtonLabel:"disable",onConfirm:()=>{ae({...Ue(i),enabled:!1})}}),[we,le]=ue({titleKey:"deleteConfirmUsers",messageKey:"deleteConfirmCurrentUser",continueButtonLabel:"delete",continueButtonVariant:pe.danger,onConfirm:async()=>{try{j?await t.users.logout({id:i.id}):await t.users.del({id:i.id}),s(a("userDeletedSuccess"),J.success),p(ot({realm:f}))}catch(P){n("userDeletedError",P)}}}),[Ae,Le]=ue({titleKey:"impersonateConfirm",messageKey:"impersonateConfirmDialog",continueButtonLabel:"impersonate",onConfirm:async()=>{try{const P=await t.users.impersonation({id:i.id},{user:i.id,realm:f});P.sameRealm?window.location=P.redirect:window.open(P.redirect,"_blank")}catch(P){n("impersonateError",P)}}});return!i||!k?e(pt,{}):y($,{children:[e(Le,{}),e(le,{}),e(ve,{}),e(sr,{titleKey:i.username,className:"kc-username-view-header",divider:!1,badges:j?[{text:e(Xt,{content:a("transientUserTooltip"),children:e(_e,{"data-testid":"user-details-label-transient-user",icon:e(Zt,{}),children:a("transientUser")})})}]:[],dropdownItems:[e(ke,{isDisabled:!i.access?.impersonate,onClick:()=>Ae(),children:a("impersonate")},"impersonate"),e(ke,{isDisabled:!i.access?.manage,onClick:()=>we(),children:a("delete")},"delete")],onToggle:P=>{P?ae({...Ue(i),enabled:P}):De()},isEnabled:i.enabled}),e(fe,{variant:"light",className:"pf-v5-u-p-0",children:e(nr,{children:e(ze,{...h,children:y(ar,{isBox:!0,mountOnEnter:!0,defaultLocation:l("settings"),children:[e(ee,{"data-testid":"user-details-tab",title:e(te,{children:a("details")}),...W,children:e(fe,{variant:"light",children:e(pr,{form:h,realm:u,user:i,bruteForce:k,userProfileMetadata:R,refresh:z,save:ae})})}),x&&e(ee,{"data-testid":"attributesTab",title:e(te,{children:a("attributes")}),...ie,children:e(Nr,{user:i,save:ae,upConfig:_})}),e(ee,{"data-testid":"credentials",isHidden:!i.access?.view,title:e(te,{children:a("credentials")}),...he,children:e(Hr,{user:i,setUser:I})}),e(ee,{"data-testid":"role-mapping-tab",isHidden:!i.access?.view,title:e(te,{children:a("roleMapping")}),...oe,children:e(Jr,{id:i.id,name:i.username})}),o("query-groups")&&e(ee,{"data-testid":"user-groups-tab",title:e(te,{children:a("groups")}),...be,children:e(_r,{user:i})}),F&&U&&e(ee,{"data-testid":"user-organizations-tab",title:e(te,{children:a("organizations")}),...Ce,children:e(Mr,{user:i})}),e(ee,{"data-testid":"user-consents-tab",title:e(te,{children:a("consents")}),...D,children:e(Br,{})}),e(ee,{"data-testid":"identity-provider-links-tab",title:e(te,{children:a("identityProviderLinks")}),...B,children:e($r,{userId:i.id})}),e(ee,{"data-testid":"user-sessions-tab",title:e(te,{children:a("sessions")}),...G,children:e(Qr,{})}),o("view-events")&&e(ee,{"data-testid":"events-tab",title:e(te,{children:a("events")}),...de,children:y(Sr,{activeKey:E,onSelect:(P,se)=>N(se),children:[e(ee,{eventKey:"userEvents",title:e(te,{children:a("userEvents")}),children:e(Ar,{user:i.id})}),e(ee,{eventKey:"adminEvents",title:e(te,{children:a("adminEvents")}),children:e(Lr,{resourcePath:`users/${i.id}`})})]})})]})})})})]})}export{$a as default};
//# sourceMappingURL=EditUser-VKbkE_8f.js.map
