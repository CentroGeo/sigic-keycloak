import{jsx as e,jsxs as r,Fragment as O}from"react/jsx-runtime";import{aH as De,ar as L,e6 as C,as as Oe,e7 as ze,cl as _e,ap as Se,e8 as Ge,h as F,e9 as Be,a as B,C as Me,E as Ee,G as $,l as re,z as oe,J as le,aI as $e,n as ce,F as Fe,Y as je,$ as J,A as xe,aj as He,M as Ke,m as We,aM as Ae,bm as Re,au as K,aG as D,aN as Ie,aL as R,H as qe,aS as de,u as me,b as Ue,V as ue,d as Q,j as Ne,B as Ye,q as Le,y as Je,P as pe,ea as X,ax as Qe,L as Xe,e5 as Ze,bq as et,T as fe,f as ne,cf as Z,ch as ee,aO as we,bx as tt,_ as st,a0 as be,by as ge,bz as ye,eb as at,aA as it,e0 as nt,dT as W,p as Te,o as rt}from"./main-Dml5vH_M.js";import*as m from"react";import{useState as w,useRef as ot,useEffect as ve,useMemo as Y}from"react";import{T as lt,c as ct,a as q,d as U,P as dt,A as mt}from"./Policies-Cdt9R5Am.js";import{u as ut,C as pt}from"./ConfirmDialog-BN0phSta.js";import{u as te,R as ht}from"./RoutableTabs-D0MTj5jQ.js";import{V as ft}from"./ViewHeader-CnGpO8mW.js";import{R as bt,u as Ve,C as gt}from"./useSortedResourceTypes-D-nXlE6v.js";import{c as Ce}from"./capitalize-BoQP_j-K.js";import{F as yt}from"./FormAccess-Dgk035ov.js";import{U as Tt}from"./NewPolicyDialog-Diogklhm.js";import{s as se}from"./sortBy-D3c44bb2.js";import{a as ae,b as ie}from"./Tabs-swfKYDgo.js";import"react-dom";import"./DescriptionListTerm-DCQWux3S.js";import"./useIsAdminPermissionsClient-IDuSpu5V.js";import"./PageHandler-BQ1_55gR.js";import"./DynamicComponents-Cxsqsl9R.js";import"./ClientSelect-DJq4F1jh.js";import"./FileUpload-B3CkDAbJ.js";import"./GroupPickerDialog-eQJqBPQt.js";import"./DataListItemRow-B3J1tfyO.js";import"./KeySelect-Ba6sDuzD.js";import"./MultiLineInput-BnUu5qtj.js";import"./AddRoleMappingModal-FlNvMd3n.js";import"./translationFormatter-DtFomvax.js";import"./useLocaleSort-DeXbTEE9.js";import"./filter-icon-BO7Evf9d.js";import"./CodeEditor-C7HQ48Ys.js";import"./useParams-Cmi1OAEj.js";import"./constants-BclHbWtx.js";import"./_baseSlice-F8doVSIJ.js";import"./ClientScopeTypes-DwzbyHD6.js";import"./utils-C-TUnOch.js";import"./SwitchControl-DVIXTwQM.js";import"./DatePicker-CU4S68sS.js";import"./debounce-DrUiQQ8A.js";import"./_baseFlatten-BhRqdSvr.js";class he extends m.Component{constructor(t){super(t),this.headingRef=m.createRef(),this.toggleCollapse=()=>{this.setState(s=>({isOpen:!s.isOpen,isTooltipVisible:!!(this.headingRef.current&&this.headingRef.current.offsetWidth<this.headingRef.current.scrollWidth)}))},this.state={isOpen:this.props.defaultIsOpen,isTooltipVisible:!1}}componentDidMount(){this.setState({isTooltipVisible:!!(this.headingRef.current&&this.headingRef.current.offsetWidth<this.headingRef.current.scrollWidth)})}renderLabel(t){const{categoryName:s,tooltipPosition:a}=this.props,{isTooltipVisible:u}=this.state;return u?m.createElement(De,{position:a,content:s},m.createElement("span",{tabIndex:0,ref:this.headingRef,className:L(C.labelGroupLabel)},m.createElement("span",{"aria-hidden":"true",id:t},s))):m.createElement("span",{ref:this.headingRef,className:L(C.labelGroupLabel),"aria-hidden":"true",id:t},s)}render(){const t=this.props,{categoryName:s,children:a,className:u,isClosable:p,isCompact:c,closeBtnAriaLabel:h,"aria-label":I,onClick:g,numLabels:l,expandedText:f,collapsedText:b,defaultIsOpen:T,tooltipPosition:G,isVertical:V,isEditable:y,hasEditableTextArea:o,editableTextAreaProps:v,addLabelControl:x}=t,P=Oe(t,["categoryName","children","className","isClosable","isCompact","closeBtnAriaLabel","aria-label","onClick","numLabels","expandedText","collapsedText","defaultIsOpen","tooltipPosition","isVertical","isEditable","hasEditableTextArea","editableTextAreaProps","addLabelControl"]),{isOpen:d}=this.state,N=m.Children.toArray(a),z=N.length,A=ze(b,{remaining:z-l}),S=k=>{const i=d?N:N.slice(0,l),M=m.createElement(m.Fragment,null,s&&this.renderLabel(k),m.createElement("ul",Object.assign({className:L(C.labelGroupList)},s&&{"aria-labelledby":k},!s&&{"aria-label":I},{role:"list"},P),i.map((_,j)=>m.createElement("li",{className:L(C.labelGroupListItem),key:j},_)),z>l&&m.createElement("li",{className:L(C.labelGroupListItem)},m.createElement(Se,{isOverflowLabel:!0,onClick:this.toggleCollapse,className:L(c&&Ge.modifiers.compact)},d?f:A)),x&&m.createElement("li",{className:L(C.labelGroupListItem)},x),y&&o&&m.createElement("li",{className:L(C.labelGroupListItem,C.modifiers.textarea)},m.createElement("textarea",Object.assign({className:L(C.labelGroupTextarea),rows:1,tabIndex:0},v))))),E=m.createElement("div",{className:L(C.labelGroupClose)},m.createElement(F,{variant:"plain","aria-label":h,onClick:g,id:`remove_group_${k}`,"aria-labelledby":`remove_group_${k} ${k}`},m.createElement(Be,{"aria-hidden":"true"})));return m.createElement("div",{className:L(C.labelGroup,u,s&&C.modifiers.category,V&&C.modifiers.vertical,y&&C.modifiers.editable)},m.createElement("div",{className:L(C.labelGroupMain)},M),p&&E)};return z===0&&x===void 0?null:m.createElement(_e,null,k=>S(this.props.id||k))}}he.displayName="LabelGroup";he.defaultProps={expandedText:"Show Less",collapsedText:"${remaining} more",categoryName:"",defaultIsOpen:!1,numLabels:3,isClosable:!1,isCompact:!1,onClick:n=>{},closeBtnAriaLabel:"Close label group",tooltipPosition:"top","aria-label":"Label group category",isVertical:!1,isEditable:!1,hasEditableTextArea:!1};const vt=({row:n})=>{const{t}=B(),s=n.associatedScopes||[];return e(he,{children:s.map((a,u)=>e(Me,{"aria-label":`Authorization scope popover for ${a.name}`,position:"top",hasAutoWidth:!0,bodyContent:r(Ee,{children:[e($,{className:"pf-v5-u-font-size-md pf-v5-u-font-weight-bold",children:t("authorizationScopeDetailsTitle")}),e($,{className:"pf-v5-u-font-size-sm",children:t("authorizationScopeDetailsSubtitle")}),r(lt,{component:ct.dl,className:"pf-v5-u-font-size-sm",children:[e(q,{component:U.dt,children:t("authorizationScopeDetailsName")}),e(q,{component:U.dd,children:Ce(a.name)}),e(q,{component:U.dt,children:t("authorizationScopeDetailsDescription")}),r(q,{component:U.dd,children:[" ",t(`authorizationScope.${n.resourceType}.${a.name}`)]})]})]}),children:e(Se,{color:"blue",children:Ce(a.name)})},u))})},Ct=({types:n,search:t,onSearch:s})=>{const{t:a}=B(),u=re({mode:"onChange",defaultValues:t}),{reset:p,formState:{isDirty:c},handleSubmit:h}=u,[I,g]=oe(),[l,f]=w([]),b=le({control:u.control,name:"resourceType",defaultValue:""}),[T,G]=w(0),V=ot("clients"),y=o=>{g(),s(o)};return ve(()=>{const o=n?.find(v=>v.type===b);f(o?.scopes||[])},[b,n]),ve(()=>{p(t),G(o=>o+1)},[t]),e($e,{toggle:o=>e(He,{"data-testid":"searchdropdown_dorpdown",ref:o,onClick:g,className:"keycloak__client_authentication__searchdropdown",children:a("searchClientAuthorizationPermission")}),isOpen:I,children:e(ce,{...u,children:r(Fe,{isHorizontal:!0,className:"keycloak__client_authentication__searchdropdown_form",onSubmit:h(y),children:[e(je,{name:"name",label:a("name")}),e(J,{name:"resourceType",label:a("type"),controller:{defaultValue:""},options:[{key:"",value:a("choose")},...n.map(({type:o,name:v})=>({key:o,value:v||o}))],onSelect:(o,v)=>{V.current!==o&&(V.current=o,u.setValue("resources",void 0)),v(o)}}),b!==""&&r(O,{children:[e(bt,{resourceType:b||"clients",withEnforceAccessTo:!1}),e(J,{name:"scope",label:a("authorizationScope"),controller:{defaultValue:""},options:[...(l||[]).map(o=>({key:o,value:o}))]})]}),r(xe,{children:[e(F,{variant:"primary",type:"submit","data-testid":"search-btn",isDisabled:!c,children:a("search")}),e(F,{variant:"link","data-testid":"revert-btn",onClick:()=>{p({}),s({})},children:a("clear")})]})]},T)})})},Pe=({resourceTypes:n,onSelect:t,toggleDialog:s})=>{const{t:a}=B();return e(Ke,{"aria-label":a("createPermission"),variant:We.medium,header:r(Ee,{children:[e($,{component:qe.h1,children:a("chooseAResourceType")}),e(de,{variant:"info",isInline:!0,title:a("chooseAResourceTypeInstructions"),component:"p"})]}),isOpen:!0,onClose:s,children:r(Ae,{"aria-label":a("permissions"),variant:"compact",children:[e(Re,{children:r(K,{children:[e(D,{children:a("resourceType")}),e(D,{children:a("description")})]})}),e(Ie,{children:Object.keys(n||{}).map(u=>{const p=n[u];return r(K,{"data-testid":p.type,onRowClick:()=>{t(p)},isClickable:!0,children:[e(R,{children:p.type}),e(R,{style:{textWrap:"wrap"},children:a(`resourceType.${p.type}`)})]},p.type)})})]})})},Pt=({clientId:n})=>{const{adminClient:t}=me(),{t:s}=B(),a=Ue(),{addAlert:u,addError:p}=ue(),{realm:c}=Q(),[h,I]=w(),[g,l]=w(),[f,b]=w({}),[T,G]=w(0),V=()=>G(T+1),[y,o]=w(10),[v,x]=w(0),[P,d]=oe(),N=Ve({clientId:n});Ne(async()=>{const i=await t.clients.listPermissionScope({first:v,max:y+1,id:n,...f});return await Promise.all((i||[]).map(async E=>{const _=await t.clients.getAssociatedPolicies({id:n,permissionId:E.id}),j=await t.clients.getAssociatedScopes({id:n,permissionId:E.id}),H=await t.clients.getAssociatedResources({id:n,permissionId:E.id});return{...E,policies:_,scopes:j,resources:H,isExpanded:!1}}))},i=>{I(i)},[T,f,v,y]);const[z,A]=ut({titleKey:"deletePermission",messageKey:s("deleteAdminPermissionConfirm",{permission:g?.name}),continueButtonVariant:Ye.danger,continueButtonLabel:"confirm",onConfirm:async()=>{try{await t.clients.delPermission({id:n,type:g?.type,permissionId:g?.id}),u(s("permissionDeletedSuccess"),Le.success),V()}catch(i){p("permissionDeletedError",i)}}});if(!h)return e(Je,{});const S=h.length===0,k=Object.keys(f).length!==0;return r(pe,{variant:"light",className:"pf-v5-u-p-0",children:[e(A,{}),(!S||k)&&r(O,{children:[P&&e(Pe,{resourceTypes:N,onSelect:i=>a(X({realm:c,permissionClientId:n,resourceType:i.type})),toggleDialog:d}),e(Qe,{count:h.length,first:v,max:y,onNextClick:x,onPreviousClick:x,onPerPageSelect:(i,M)=>{x(i),o(M)},toolbarItem:r(O,{children:[e(fe,{children:e(Ct,{types:N,search:f,onSearch:b})}),e(fe,{children:e(F,{"data-testid":"createScopeBasedPermissionBtn",variant:"primary",onSelect:i=>a(X({realm:c,permissionClientId:n,resourceType:i.type})),onClick:d,children:s("createPermission")},"confirm")})]}),children:!S&&r(Ae,{"aria-label":s("permissions"),variant:"compact",children:[e(Re,{children:r(K,{children:[e(D,{"aria-hidden":"true"}),e(D,{children:s("adminPermissionName")}),e(D,{children:s("resourceType")}),e(D,{children:s("authorizationScopes")}),e(D,{children:s("description")}),e(D,{"aria-hidden":"true"})]})}),h.map((i,M)=>r(Ie,{isExpanded:i.isExpanded,children:[r(K,{children:[e(R,{expand:{rowIndex:M,isExpanded:i.isExpanded,onToggle:(E,_)=>{const j=h.map((H,ke)=>ke===_?{...H,isExpanded:!H.isExpanded}:H);I(j)}}}),e(R,{"data-testid":`name-column-${i.name}`,children:e(Xe,{to:Ze({realm:c,permissionClientId:n,permissionId:i.id,resourceType:i.resourceType}),children:i.name})}),e(R,{children:i.resourceType}),e(R,{children:e(vt,{row:{resourceType:i.resourceType||"",associatedScopes:i.scopes?.map(E=>({name:E.name||""}))}})}),e(R,{children:i.description||"—"}),e(R,{actions:{items:[{title:s("delete"),onClick:async()=>{l(i),z()}}]}})]}),r(K,{isExpanded:i.isExpanded,children:[e(R,{}),e(R,{colSpan:5,children:e(et,{children:i.isExpanded&&r(O,{children:[e(D,{children:s("resources")}),i.resources&&i.resources?.length>0?i.resources.map((E,_)=>e(R,{children:e("span",{style:{marginLeft:"8px"},children:E.displayName||E.name})},_)):e(R,{children:e("span",{style:{marginLeft:"8px"},children:s("allResources")})}),e("br",{}),e(D,{children:s("assignedPolicies")}),i.policies.map((E,_)=>e(R,{children:e("span",{style:{marginLeft:"8px"},children:E.name})},_))]})})})]},`child-${i.id}`)]},i.id))]})})]}),S&&!k&&r(O,{children:[P&&e(Pe,{resourceTypes:N,onSelect:i=>a(X({realm:c,permissionClientId:n,resourceType:i.type})),toggleDialog:d}),e(ne,{message:s("emptyPermissions"),instructions:s("emptyPermissionsInstructions"),primaryActionText:s("createPermission"),onPrimaryAction:d})]}),S&&k&&e(ne,{isSearchVariant:!0,message:s("noSearchResults"),instructions:s("noPermissionSearchResultsInstructions")})]})},St=({evaluateResult:n})=>{const{t}=B(),a=(n?.results||[])[0]||{},u=a?.resource?.name??t("permissionEvaluationAlertTitle"),p=n?.status==="PERMIT"?"success":"warning",c=Y(()=>se(a?.allowedScopes||[],"name"),[a]),h=Y(()=>se(a?.deniedScopes||[],"name"),[a]),I=Y(()=>se(a?.policies||[],"name"),[a]),g=function(l,f){const b=I.filter(T=>T.status===f);if(b.length!=0)return r(O,{children:[r($,{className:"pf-v5-u-pt-sm",children:[e("strong",{children:t(l)}),":"]}),e(Z,{className:"pf-v5-u-mt-sm",children:b.map(T=>e(ee,{children:t("evaluatedPolicy",{name:T.policy?.name,status:T.status})},T.policy?.id))})]})};return r(de,{isInline:!0,variant:p,title:u,component:"h6",children:[c.length>0&&r(O,{children:[e($,{children:e("b",{children:t("grantedScope")})}),e(Z,{className:"pf-v5-u-mt-sm",children:c.map(l=>e(ee,{children:l.name},l.id))})]}),h.length>0&&r(O,{children:[e($,{className:"pf-v5-u-pt-sm",children:e("strong",{children:t("deniedScope")})}),e(Z,{className:"pf-v5-u-mt-sm",children:h.map(l=>e(ee,{children:l.name},l.id))})]}),g("grantedPermissions","PERMIT"),g("deniedPermissions","DENY")]})},Et=n=>{const{hasAccess:t}=we();return t("view-users")?e(xt,{...n}):e(tt,{permissionNeeded:"view-users"})},xt=({client:n})=>{const{t}=B(),{adminClient:s}=me(),a=Q(),{addError:u}=ue(),p=re({mode:"onChange",defaultValues:{user:[],resourceType:"",authScopes:[]}}),{control:c,getValues:h,reset:I,trigger:g}=p,[l,f]=w(),[b,T]=w(!0),[G,V]=w(!1),y=Ve({clientId:n.id}),o=le({control:c,name:"resourceType",defaultValue:""}),v=Y(()=>y.find(N=>N.type===o)?.scopes||[],[o,y]),x=gt[o?.toLowerCase()||""],P=async()=>{if(!await g())return;const d=h(),z=(S=>{switch(S){case"Groups":return d.groups?.[0];case"Users":return d.users?.[0];case"Clients":return d.clients?.[0];case"Roles":return d.roles?.[0];default:return}})(d.resourceType),A={roleIds:d.roleIds??[],userId:d.user[0],resourceType:d.resourceType,resources:[{name:z,scopes:d.authScopes.map(S=>({name:S}))}],entitlements:!1,context:{attributes:{}}};try{const S=await s.clients.evaluateResource({id:n.id,realm:a.realm},A);f(S),V(!0)}catch(S){u("evaluateError",S)}};return e(pe,{children:r(st,{hasGutter:!0,children:[e(be,{children:r(ce,{...p,children:[e(ge,{children:e(ye,{style:{width:"50rem"},children:r(yt,{isHorizontal:!0,role:"view-clients",children:[b&&e(de,{variant:"info",isInline:!0,title:t("permissionsEvaluationInstructions"),component:"p",actionClose:e(at,{onClose:()=>T(!1)})}),e(Tt,{name:"user",label:t("user"),helpText:t("selectUser"),defaultValue:[],variant:"typeahead",isRequired:!0}),e(J,{name:"resourceType",label:t("resourceType"),labelIcon:t("resourceTypeSelectHelp"),variant:"single",controller:{defaultValue:y.length?y[0]?.type:"",rules:{required:!0}},options:y.map(d=>d.type)}),x&&e(x,{name:o?.toLowerCase(),label:t(`${o}`),helpText:t(`select${o}`),defaultValue:[],variant:"typeahead",isRequired:!0,isRadio:!0}),e(J,{name:"authScopes",label:t("authScope"),labelIcon:t("authScopeSelectHelp"),controller:{defaultValue:[]},variant:"single",options:v})]})})}),r(xe,{children:[e(F,{"data-testid":"permission-eval",id:"permission-eval",className:"pf-v5-u-mr-md",isDisabled:!p.formState.isValid,onClick:()=>P(),children:t("evaluate")}),e(F,{"data-testid":"permission-eval-revert",id:"permission-eval-revert",className:"pf-v5-u-mr-md",variant:"link",onClick:()=>{I(),f({}),V(!1)},children:t("revert")})]})]})}),e(be,{children:r(ge,{children:[e(dt,{children:e(it,{headingLevel:"h1",size:"md",children:t("permissionEvaluationPreview")})}),e(ye,{children:G?e(St,{evaluateResult:l}):e(ne,{icon:nt,message:t("noPermissionsEvaluationResults"),instructions:t("noPermissionsEvaluationResultsInstructions")})})]})})]})})};function ds(){const{adminClient:n}=me(),{t}=B(),{realm:s}=Q(),{hasAccess:a}=we(),{addAlert:u,addError:p}=ue(),[c,h]=w(),[I,g]=oe(),l=re(),{realmRepresentation:f}=Q(),b=le({control:l.control,name:"clientAuthenticatorType",defaultValue:"client-secret"}),T=a("manage-authorization"),G=a("view-users"),V=te(W({realm:s,permissionClientId:f?.adminPermissionsClient?.id,tab:"permissions"})),y=te(W({realm:s,permissionClientId:f?.adminPermissionsClient?.id,tab:"policies"})),o=te(W({realm:s,permissionClientId:f?.adminPermissionsClient?.id,tab:"evaluation"}));Ne(async()=>(await n.clients.find({clientId:"admin-permissions"}))[0],P=>{h(P)},[]);const v=P=>{l.reset({...P}),rt(P,l.setValue)},x=async({confirmed:P=!1,messageKey:d="clientSaveSuccess"}={confirmed:!1,messageKey:"clientSaveSuccess"})=>{if(!await l.trigger())return;if(!c?.publicClient&&c?.clientAuthenticatorType!==b&&!P){g();return}const N=Te(l.getValues()),z=Te(N);try{const A={...c,...z};A.clientId=A.clientId?.trim(),await n.clients.update({id:c.clientId},A),v(A),h(A),u(t(d),Le.success)}catch(A){p("clientSaveError",A)}};return c&&r(O,{children:[e(pt,{continueButtonLabel:"yes",cancelButtonLabel:"no",titleKey:t("changeAuthenticatorConfirmTitle",{clientAuthenticatorType:b}),open:I,toggleDialog:g,onConfirm:()=>x({confirmed:!0}),children:e(O,{children:t("changeAuthenticatorConfirm",{clientAuthenticatorType:b})})}),e(pe,{variant:"light",className:"pf-v5-u-p-0",children:r(ce,{...l,children:[e(ft,{titleKey:t("permissions"),subKey:t("permissionsSubTitle")}),r(ht,{mountOnEnter:!0,unmountOnExit:!0,defaultLocation:W({realm:s,permissionClientId:c.id,tab:"permissions"}),children:[e(ae,{id:"resources","data-testid":"permissionsResources",title:e(ie,{children:t("permissions")}),...V,children:e(Pt,{clientId:c.id})}),e(ae,{id:"policies","data-testid":"permissionsPolicies",title:e(ie,{children:t("policies")}),...y,children:e(mt,{clientId:c.id,isDisabled:!T})}),G&&e(ae,{id:"evaluation","data-testid":"permissionsEvaluation",title:e(ie,{children:t("evaluation")}),...o,children:e(Et,{client:c,save:x})})]})]})})]})}export{ds as default};
//# sourceMappingURL=PermissionsConfigurationSection-CCBbWjoQ.js.map
